name: K3S Installation, Rancher Setup, Chart Installation & E2E Tests

on:
  push:
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *' # Runs daily at 3:00 AM UTC (9:30 AM IST)

jobs:
  setup_rancher:
    name: Setup Rancher - Tag - ${{ matrix.rancher_version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - k3s_version: v1.30.14+k3s2
            rancher_version: latest/devel/2.10
          - k3s_version: v1.31.11+k3s1
            rancher_version: latest/devel/2.11
          - k3s_version: v1.32.7+k3s1
            rancher_version: latest/devel/2.12
      fail-fast: false

    steps:
      - name: Set environment variables
        run: |
          echo "HOSTNAME_NAME=localhost" >> $GITHUB_ENV
          echo "RANCHER_VERSION=${{ matrix.rancher_version }}" >> $GITHUB_ENV
          echo "K3S_VERSION=${{ matrix.k3s_version }}" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version-file: './go.mod'

      - name: Install K3S Version ${{ matrix.k3s_version }} & Rancher Version ${{ matrix.rancher_version }}
        id: install_k3s_and_rancher
        run:
          set -e
          go test -timeout 30m -run ^TestE2E$ github.com/rancher/observability-e2e/installations/k3s -v -ginkgo.v

      - name: Create artifacts directory
        run: mkdir -p ~/artifacts

      - name: Export CATTLE_TEST_CONFIG environment variable
        run: echo "CATTLE_TEST_CONFIG=$HOME/cattle-config.yaml" >> $GITHUB_ENV

      - name: Run Observability Charts Tests
        id: run_observability_tests
        run: |
          set -e
          TEST_LABEL_FILTER=installation go test -timeout 20m github.com/rancher/observability-e2e/tests/e2e -v -count=1 -ginkgo.v | tee ~/artifacts/test-output-installation-${{ matrix.tag }}.txt
          TEST_LABEL_FILTER=E2E go test -timeout 30m github.com/rancher/observability-e2e/tests/e2e -v -count=1 -ginkgo.v | tee ~/artifacts/test-output-e2e-${{ matrix.tag }}.txt
